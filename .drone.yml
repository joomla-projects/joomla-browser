---
kind: pipeline
name: default

clone:

steps:
  - name: composer
    image: joomlaprojects/docker-images:php7.4
    volumes:
      - name: composer-cache
        path: /tmp/composer-cache
    commands:
      - composer validate --no-check-all --strict
      - composer install --no-progress --no-suggest

  - name: phpcs
    image: joomlaprojects/docker-images:php7.4
    commands:
      - echo $(date)
      - ./vendor/bin/phpcs --extensions=php -p --standard=vendor/joomla/coding-standards/Joomla src
      - echo $(date)

  - name: prepare_test_environment
    image: joomlaprojects/docker-images:php7.4
    volumes:
      - name: composer-cache
        path: /tmp/composer-cache
    commands:
      - echo $(date)
      - mkdir cache
      - mkdir test-install
      - cd cache
      - git clone git@github.com:joomla/joomla-cms.git . --depth 1
      - composer install
      - npm i
      - cp -a cache/. test-install/

  - name: acceptance_tests
    image: joomlaprojects/docker-images:systemtests
    commands:
      - apache2ctl -D FOREGROUND &
      - google-chrome --version
      - xvfb-run java -Dwebdriver.chrome.driver=/usr/bin/chromedriver -jar selenium-server-standalone.jar
      - ./vendor/bin/codecept build
      - ./vendor/bin/codecept run --fail-fast --steps --debug tests/acceptance

volumes:
  - name: composer-cache
    host:
      path: /tmp/composer-cache

services:
  - name: mysql
    image: mysql:5.7
    environment:
      MYSQL_USER: joomla_ut
      MYSQL_PASSWORD: joomla_ut
      MYSQL_ROOT_PASSWORD: joomla_ut
      MYSQL_DATABASE: test_joomla

---
kind: signature
hmac: 42128ad2465222bf54d2e588689d01d508ef55cb8556a58dd7e5def88cef76c1

...
