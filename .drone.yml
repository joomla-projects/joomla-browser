---
kind: pipeline
name: default

clone:

steps:
  - name: composer
    image: joomlaprojects/docker-images:php7.4
    volumes:
      - name: composer-cache
        path: /tmp/composer-cache
    commands:
      - composer validate --no-check-all --strict
      - composer install --no-progress --no-suggest

  - name: phpcs
    image: joomlaprojects/docker-images:php7.4
    commands:
      - echo $(date)
      - ./vendor/bin/phpcs --extensions=php -p --standard=vendor/joomla/coding-standards/Joomla src
      - echo $(date)

  - name: prepare_test_environment
    image: joomlaprojects/docker-images:php7.4
    volumes:
      - name: composer-cache
        path: /tmp/composer-cache
    commands:
      - echo $(date)
      - mkdir cache
      - mkdir test-install
      - cd cache
      - git clone https://github.com/joomla/joomla-cms.git . --depth 1
      - composer install

  - name: npm
    image: node:14-alpine
    commands:
      - cd cache
      - npm i --unsafe-perm

  - name: acceptance_tests
    image: joomlaprojects/docker-images:systemtests
    commands:
      - cp -a cache/. test-install/
      - apache2ctl -D FOREGROUND &
      - google-chrome --version
      - selenium-standalone start > tests/_output/selenium.log 2>&1 &
      - ./vendor/bin/codecept build
      - ./vendor/bin/codecept run --fail-fast --steps --debug tests/acceptance

volumes:
  - name: composer-cache
    host:
      path: /tmp/composer-cache

services:
  - name: mysql
    image: mysql:5.7
    environment:
      MYSQL_USER: joomla_ut
      MYSQL_PASSWORD: joomla_ut
      MYSQL_ROOT_PASSWORD: joomla_ut
      MYSQL_DATABASE: test_joomla

---
kind: signature
hmac: 6e14977ea328f3dd03edada245ffe67a1d4d92a93b460cb6c8098b55191810d1

...
